<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>TourChamp: Win At Traveling</title>
    <meta name="description" content="This one page example has a fixed navbar and full page height sections. Each section is vertically centered on larger screens, and then stack responsively on smaller screens. Scrollspy is used to activate the current menu item. This layout also has a contact form example. Uses animate.css, FontAwesome, Google Fonts (Lato and Bitter) and Bootstrap." />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Codeply">

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" />
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" rel="stylesheet" />

    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body >
    <nav class="navbar navbar-trans navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapsible">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand text-danger" href="#">TourChamp</a>
        </div>
        <div class="navbar-collapse collapse" id="navbar-collapsible">
            <!-- <ul class="nav navbar-nav navbar-left">
                <li><a href="#section1">Start</a></li>
                <li><a href="#section2">Next</a></li>
                <li><a href="#section3">Then</a></li>
                <li><a href="#section4">Form</a></li>
                <li><a href="#section5">More</a></li>
                <li><a href="#section6">Last</a></li>
                <li>&nbsp;</li>
            </ul> -->            
            <ul class="nav navbar-nav navbar-right" data-bind='if: user && user()'>
                <li>
                    <img style='border-radius:100px' data-bind='attr: {src : tc.user().avatar_url }'/>
                </li>            
                <li data-bind='if: user() && user().points && user().points > 0'>
                    <a data-bind='text: user().displayName+" ("+(user().points || 0)+")", attr: { href: encodeURI("#user/"+user().username) }'></a>
                </li>
                <li>
                    <a href='#logout'>Logout</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<section class="container-fluid" id="section1">
    <div class="v-center">
        <h1 class="text-center">TourChamp</h1>
        <h2 class="text-center lato animate slideInDown">Win at <b>Traveling</b></h2>
        <p class="text-center">
            <br>
            <a href="#" class="btn btn-danger btn-lg btn-huge lato" data-toggle="modal" data-target="#myModal" data-bind='click: fb_login'>Enter with Facebook</a>
        </p>
    </div>
        <!-- <a href="#section2">
		<div class="scroll-down bounceInDown animated">
            <span>
                <i class="fa fa-angle-down fa-2x"></i>
            </span>
		</div>
        </a> -->
</section>

<section class="container-fluid" id="section2" style='margin-top: 10px'>
    <div class="container v-center">
        <h2 class="text-center lato" style='padding-bottom: 40px'>
                <span data-bind="text: themeTitle"></span>
        </h2>
        <div class="row">
            <ul data-bind="foreach: challenges">
            <div class="col-sm-4">                
                    <div class="row">
                        <div class="col-sm-12 text-center">
                            <div class="panel panel-default slideInLeft animate">
                                <div class="panel-heading">
                                    <h3>
                                        <a data-bind='text: attributes.name, attr: { href: "#challenge/"+id }'></a>
                                    </h3>
                                </div>

                                <div class="panel-body">
                                    <p data-bind='text: attributes.description'></p>
                                    <hr>
                                    <p class='btn btn-success' data-bind='click: $parent.submitChallenge, visible: !$data.completed()'>DONE (<span data-bind='text: attributes.points'></span> points)</p>
                                    <p class='btn btn-info' disabled="disabled" data-bind='visible: $data.completed()'>DONE! (<span data-bind='text: attributes.points'></span> points)</p>

                                    <form name="form1" enctype="multipart/form-data"
                                          onsubmit="startUpload();">
                                        <input type="file" id="profilePhotoFileUpload">
                                        <input type="submit" value="SUBMIT" />
                                    </form>
                                    <!-- <p data-bind='visible: done'>DONE</p> -->
                                    <hr>
                                </div>
                            </div>
                        </div>
                    </div>                
            </div>
            </ul>
        </div>
        <!--/row-->
        <div class="row">
            <br>
        </div>
    </div>
    <!--/container-->
</section>

<section>
    <div class="container-fluid v-center">
        <div class="row">
            <div class="col-sm-2 col-sm-offset-2 col-xs-6">
                <div class="text-center">
                    <a href="">
                        <img style="width:100px;" class="img-circle img-responsive img-thumbnail" src="//placehold.it/100/444">
                    </a>
                    <h3 class="text-center"></h3>
                </div>
            </div>
            <div class="col-sm-2 col-xs-6">
                <div class="text-center">
                    <a href="">
                        <img style="width:100px;" class="img-circle img-responsive img-thumbnail" src="//placehold.it/100/444">
                    </a>
                    <h3 class="text-center"></h3>
                </div>
            </div>
            <div class="col-sm-2 col-xs-6">
                <div class="text-center">
                    <a href="">
                        <img style="width:100px;" class="img-circle img-responsive img-thumbnail" src="//placehold.it/100/444">
                    </a>
                    <h3 class="text-center"></h3>
                </div>
            </div>
            <div class="col-sm-2 col-xs-6">
                <div class="text-center">
                    <a href="">
                        <img style="width:100px;" class="img-circle img-responsive img-thumbnail" src="//placehold.it/100/444">
                    </a>
                    <h3 class="text-center"></h3>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-2 col-sm-offset-2 col-xs-6">
                <div class="text-center">
                    <a href="">
                        <img style="width:100px;" class="img-circle img-responsive img-thumbnail" src="//placehold.it/100/444">
                    </a>
                    <h3 class="text-center"></h3>
                </div>
            </div>
            <div class="col-sm-2 col-xs-6">
                <div class="text-center">
                    <a href="">
                        <img style="width:100px;" class="img-circle img-responsive img-thumbnail" src="//placehold.it/100/444">
                    </a>
                    <h3 class="text-center"></h3>
                </div>
            </div>
            <div class="col-sm-2 col-xs-6">
                <div class="text-center">
                    <a href="">
                        <img style="width:100px;" class="img-circle img-responsive img-thumbnail" src="//placehold.it/100/444">
                    </a>
                    <h3 class="text-center"></h3>
                </div>
            </div>
            <div class="col-sm-2 col-xs-6">
                <div class="text-center">
                    <a href="">
                        <img style="width:100px;" class="img-circle img-responsive img-thumbnail" src="//placehold.it/100/444">
                    </a>
                    <h3 class="text-center"></h3>
                </div>
            </div>
        </div>
        <!--/row-->
    </div>
</section>

<section class="container-fluid" id="section3">
    <h1 class="text-center" data-bind='text: challenge_name'></h1>
    <div class="row">
        <div class="col-sm-6 col-sm-offset-3">
            <h3 class="text-center lato slideInUp animate" data-bind='text: challenge_location'></h3>
            <br>
            <div class="row">
                <div class='col-xs-11 col-xs-offset-1' data-bind='text: challenge_desc'></div>
            </div>
            <br>
            <p class="text-center">
                <img data-bind='attr: { src: $data.img || tc.randomImageSrc(400,400) }' class="img-responsive thumbnail center-block ">
            </p>
        </div>
    </div>
</section>
<!-- HERE1 -->
<section class="container-fluid" id="section8" data-bind="if: user()">
     <h1 class="text-center" data-bind='text: user().displayName'></h1>

    <div class="row">
        <div class="col-sm-6 col-sm-offset-3">
            <h2 class="text-center" data-bind='text: "Points: "+user().points'></h1>
            <hr>
            <h2 class="text-center lato slideInUp animate">Badges received:</h2>
            <ul data-bind="foreach: badges_received">
                    <div class="media-left">
                        <img data-bind='attr: { src: $data.img || tc.randomImageSrc() }'>
                    </div>
                <div class="media-body media-middle">
                     <a data-bind='text: attributes.badge, attr: { href: "#theme/"+id }'></a>
                </div>
                <br>
            </ul>            
            <hr>
            <h2 class="text-center lato slideInUp animate">Challenges completed:</h2>
            <br>
            <ul data-bind="foreach: challenges_completed">
                <div class="media-left">
                    <img data-bind='attr: { src: $data.img || tc.randomImageSrc() }'>
                </div>
                <div class="media-body media-middle">
                <a data-bind='text: attributes.name, attr: { href: "#challenge/"+id }'></a>
                </div>
                <br>
            </ul>            
    </div>
</section>


<section id="section4">
    <div class="container v-center">
        <div class="row">
            <div class="col-md-12">
                <h1 class="text-center">Make Contact</h1>
                <hr>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-9">
                <div class="row form-group">
                    <div class="col-sm-3">
                        <input type="text" class="form-control" id="firstName" name="firstName" placeholder="First Name" required="">
                    </div>
                    <div class="col-sm-3">
                        <input type="text" class="form-control" id="middleName" name="firstName" placeholder="Middle Name" required="">
                    </div>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" id="lastName" name="lastName" placeholder="Last Name" required="">
                    </div>
                </div>
                <div class="row form-group">
                    <div class="col-sm-5">
                        <input type="email" class="form-control" name="email" placeholder="Email" required="">
                    </div>
                    <div class="col-sm-5">
                        <input type="email" class="form-control" name="phone" placeholder="Phone" required="">
                    </div>
                </div>
                <div class="row form-group">
                    <div class="col-sm-10">
                        <input type="homepage" class="form-control" placeholder="Website URL" required="">
                    </div>
                </div>
                <div class="row form-group">
                    <div class="col-sm-10">
                        <button class="btn btn-default btn-lg pull-right">Contact Us</button>
                    </div>
                </div>
            </div>
            <div class="col-sm-3 pull-right">
                <address>
              <strong>Some LLC</strong><br>
              795 Folsom Ave, Suite 600<br>
              Newport, RI 94107<br>
              P: (123) 456-7890
            </address>
                <address>
              <strong>Email Us</strong><br>
              <a href="mailto:#">ohad.partuck@gmail.com</a>
            </address>
            </div>
        </div>
    </div>
</section>

<section class="container-fluid" id="section5">
    <div class="row">
        <div class="col-sm-6 col-sm-offset-3 col-md-4 col-md-offset-4">
            <h2 class="text-center lato">
                Badges to achieve near <span data-bind="text: city"></span>
            </h2>

            <select class='form-control' data-bind="visible: chooseCities, 
            options: availableCities, 
            optionsCaption: 'Select...',
            selectedOptions: city,event:{ change: function(){ redirect('#city/'+$data.city()[0]); chooseCities(false);} }" style='width:100%;'>
                <option selected disabled>Choose here</option>
            </select>
            <p class='text-right' style='font-size=smaller'><a href='#' data-bind="click: function(){ chooseCities(!chooseCities()) }">elsewhere?</a></p>
            <hr>
            <ul data-bind="foreach: themes">
                <div class="media">
                <h3>
                   <a data-bind='text: attributes.badge, attr: { href: "#theme/"+id }'></a>
                </h3>
                    <div class="media-left">
                        <img class="theme_img" data-bind='attr: { src: attributes.photo_url || tc.randomImageSrc() }'>
                    </div>
                    <div class="media-body media-middle">
                        <p data-bind='text: attributes.description'></p>
                    </div>
                </div>
                <hr>
            </ul>            

        </div>
    </div>
</section>

<section class="container-fluid" id="section6">
    <ul class="row list-unstyled">
        <li class="col-md-6 col-md-offset-1 col-xs-10 col-xs-offset-1">
            <h3 class="text-center">This will scale down proportionately.</h3>
        </li>
        <li class="col-md-3 col-md-offset-0 col-xs-10 col-xs-offset-1 text-center">
            <a href="" class="center-block btn btn-default btn-lg btn-huge lato animate slideInRight">Responsive Design</a>
        </li>
    </ul>
</section>

<section class="container-fluid" id="section7">
    <div class="row">
        <!--fontawesome icons-->
        <div class="col-sm-1 col-sm-offset-3 col-xs-4 text-center">
            <i class="fa fa-github fa-4x"></i>
        </div>
        <div class="col-sm-1 col-xs-4 text-center">
            <i class="fa fa-foursquare fa-4x"></i>
        </div>
        <div class="col-sm-1 col-xs-4 text-center">
            <i class="fa fa-pinterest fa-4x"></i>
        </div>
        <div class="col-sm-1 col-xs-4 text-center">
            <i class="fa fa-google-plus fa-4x"></i>
        </div>
        <div class="col-sm-1 col-xs-4 text-center">
            <i class="fa fa-twitter fa-4x"></i>
        </div>
        <div class="col-sm-1 col-xs-4 text-center">
            <i class="fa fa-dribbble fa-4x"></i>
        </div>
    </div>
</section>
    <!--scripts loaded here-->
    

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
        <script>
            $('section').hide();
            //$('#section5').show();
            //$('#theme').show();
        </script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>    
    <script src="js/theme_js.js"></script>
    <script src="js/knockout.min.js"></script>

    <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.4.2.min.js"></script>
    <script>
    Parse.initialize("mWYkCl2OixqTNVogAN8QwSWJvz7R0ll7hWYyJs3P", "YBIy6ufbozlkSeGbbVzTQUOBUF20IhmYuGuPQjFx");
    </script>

    <script src="js/sammy.js"></script>
    <script src="js/fb_login.js"></script>
    <script src="js/upload_images.js"></script>
<script>

function getThemesForCity(city_name, callback) {
    console.log("Getting themes for city");
    var Theme = Parse.Object.extend("Theme");
    var query = new Parse.Query(Theme);
    query.equalTo("city", city_name);
    query.find({  
        success: function(results) { 
            if (callback) {
                callback(results);
            }
        },  
        error: function(error) {  
            console.log(error); 
        } 
    });    
}

function getChallengesForTheme(themeId, callback) {
    var query = new Parse.Query("Theme");
    query.include("challenges");
    query.get( themeId, {  
        success: function(result) { 
            if (callback) {
                callback(result);
            }
        },  
        error: function(error) {  
            console.log(error); 
        } 
    });    
}

function getChallengeById(challengeId, callback) {
    var query = new Parse.Query("Challenge");
    query.get( challengeId, {  
        success: function(result) { 
            if (callback) {
                callback(result);
            }
        },  
        error: function(error) {  
            console.log(error); 
        } 
    });    
}

function getAllChallenges(callback) {
    var query = new Parse.Query("Challenge");
    if (tc.allChallenges) {
        callback(tc.allChallenges);
    } else {
        query.find({
            success: function(results) { 
                var challengeHash = {}
                for (var i = 0; i < results.length; i++) {
                    challengeHash[results[i].id] = results[i]
                }

                tc.allChallenges = challengeHash;
                callback(challengeHash);
            },  
            error: function(error) {  
                console.log(error); 
            } 
        });
    }
}

function getAllThemes(callback) {
    var query = new Parse.Query("Theme");
    if (tc.allThemes) {
        callback(tc.allThemes);
    } else {
        query.find({
            success: function(results) { 
                var themeHash = {}
                for (var i = 0; i < results.length; i++) {
                    themeHash[results[i].id] = results[i]
                }

                tc.allThemes = themeHash;
                callback(themeHash);
            },  
            error: function(error) {  
                console.log(error); 
            } 
        });
    }    
}

function getChallengeByIds(challengeIds, callback) {
    getAllChallenges(function(allChallenges) {
        var challenges = [];
        for (var i = 0; i < challengeIds.length; i++) {
            challenges.push(allChallenges[challengeIds[i]]);
        }

        callback(challenges);
    })
}

function getThemesByIds(themeIds, callback) {
    getAllThemes(function(allThemes) {
        var themes = [];
        for (var i = 0; i < themeIds.length; i++) {
            themes.push(allThemes[themeIds[i]]);
        }

        callback(themes);
    })
}


function getUserChallenges(user, callback) {
    var challengeIds = Object.keys(user.challenges_completed);
    getChallengeByIds(challengeIds, callback);
}

function getUserBadges(user, callback) {
    var themeIds = Object.keys(user.themes_completed);
    getThemesByIds(themeIds, callback)
}

var tc; //TourChamp

var defThemes = [
{name:"theme name 123",desc:'my desc1',points:2,id:'theme_id_123',
 attributes:{ description:'my desc 2',points:20, name:"theme name 456"}}, 

{name:"theme name 456",desc:'my desc 2',points:20,id:'theme_id_456', attributes: {}}];

var defChallenges = [
        {name: 'challenge1', id: 'challenge_id_1', subtitle: "my subtitle", desc: "challenge 1 desc - really cool challenge", done: 'yes'},
        {name: 'challenge2', id: 'challenge_id_2', bla: 'foo'},

        {name: 'challenge3', id: 'challenge_id_3', done: 'yes'},
        {name: 'challenge4', id: 'challenge_id_4', done: 'yes'},
        {name: 'challenge5', id: 'challenge_id_5'},
        {name: 'challenge6', id: 'challenge_id_6'},
        {name: 'challenge7', id: 'challenge_id_7', done: 'yes'},
        ];

var defBadges = [
    {id:'theme_id_123', name: 'Badge1'},
    {id:'theme_id_345', name: 'Badge2'}
];



set = function(field,val) { tc[field](val) };
var lastSection = null;
show = function(sectionID) { 
  if (lastSection == sectionID) return;
  $('section').hide();
  $(sectionID).show();
  lastSection = sectionID;
}
redirect = function(route) { document.location.href = route; };
// This is a simple *viewmodel* - JavaScript that defines the data and behavior of your UI

function vm() {
  tc = self = this;
  self.firstName = "Bert";
  self.lastName = "Bertington";
  self.color = ko.observable("blue");
  self.foo = ko.observable();
  self.randomImageSrc = function(x,y) {
    x = x || 100
    y = y || 100
    return "http://lorempixel.com/"+x+"/"+y+"/?rnd="+Math.random();
  }

  //user  
  self.user = ko.observable(null); 
  if (oldUser = localStorage.getItem('user')) self.user(JSON.parse(oldUser));
  //self.user({displayName: 'fake user'})

  //city view
  self.city = ko.observable("");
  self.title = ko.observable("");  
  self.themes = ko.observable(defThemes)
  self.chooseCities = ko.observable("");
  self.availableCities = ko.observable(['Tel-Aviv','Barcelona','Madrid','Berlin']);  

  //theme view
  self.themeTitle = ko.observable("");  
  self.challenges = ko.observableArray("");
  self.challenges_completed = ko.observableArray("");
  self.badges_received = ko.observableArray("");

  //challenge view
  self.challengeTitle = ko.observable("");
  self.challenge_name = ko.observable("");
  self.challenge_desc = ko.observable("");
  self.challenge_location = ko.observable("");

  self.showCity = function(themes) {
    self.title('Themes');
    self.themes(themes);
    show('#section5');
  };

  self.showTheme = function(theme) {
    self.themeTitle('"'+theme.attributes.name+'" Badge');

    self.challenges((theme && theme.attributes && theme.attributes.challenges) || defChallenges);
    show("#section2");
  };

  self.showChallenge = function(challenge) {
    self.challengeTitle('Challenge info for '+challenge.id);
    self.challenge_name(challenge.attributes.name);
    self.challenge_location(challenge.attributes.location);
    self.challenge_desc(challenge.attributes.description);
    show("#section3");
  }

  self.showUserPage = function(userID) {
    self.title('Themes');
    // console.log(tc.user().challenges_completed);
    getUserChallenges(tc.user(), function(challenges) {
        self.challenges_completed(challenges);
    });

    getUserBadges(tc.user(), function(badges) {
        self.badges_received(badges);
    });

    show("#section8");
  }

  self.submitChallenge = function(challenge) {    
    function updateCompleted(id) {
        challenge.completed(true);
        reloadUserData(); //update points and stuff
    }
    Parse.Cloud.run('mark_challenge_completed', { challenge_id: challenge.id }, {
        success: function(response) {
            updateCompleted(challenge.id);
        },
      error: function(error) { 
            updateCompleted(challenge.id);
        }
    });
  }



  Sammy(function() {
        this.get('#city/:city', function() {
            if (!self.user()) return this.redirect('/#');
            self.city(this.params.city);            

            getThemesForCity(this.params.city, function(themes) {
                self.showCity(themes);
            });
        });

        this.get('#theme/:theme_id', function() {  
            if (!self.user()) return this.redirect('/#');
            getChallengesForTheme(this.params.theme_id, function(theme) {
                theme.attributes.challenges.map(function(c) { 
                    var hasCompletedThisChallenge = !!(tc.user().challenges_completed || {})[c.id];
                    c.completed = ko.observable(hasCompletedThisChallenge); 

                    return c; 
                }); 
                self.showTheme(theme);
            })
        });

        this.get('#challenge/:challenge_id', function() {
            if (!self.user()) return this.redirect('/#');
            //$.get("/mail", { folder: this.params.folder }, self.showThemes);
            getChallengeById(this.params.challenge_id, function(challenge) {
                self.showChallenge(challenge);
            });
        });

        this.get('#logout', function() {
            //$.get("/mail", { folder: this.params.folder }, self.showThemes);
            try {
                localStorage.removeItem('user');
            }
            catch(e){  console.log(e); }
            redirect('/#');
        });

        this.get('#user/:username', function() {
            //$.get("/mail", { folder: this.params.folder }, self.showThemes);
            self.showUserPage(this.params.username);
        });

        this.get('', function() { 
            if (! localStorage.getItem('user')) tc.user(null);

            if (tc.user()) {
                redirect('/#city/Tel-Aviv');
                return;
            }
            show("#section1");
        });
  }).run(); 
}
// Activates knockout.js
ko.applyBindings(new vm());
set('foo','bar');

</script>
  </body>
</html>


